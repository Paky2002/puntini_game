<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="/static/style.css" rel="stylesheet" >
    <title>Unisci i punti</title>
  </head>
  <body>
    <div id="particelle">

    </div>
    <div class = "row">
      <div class="col-3">
        <p id="timer">00:00</p>
      </div>
      <div class="col-6">
        
      </div>
      <div class="col-3">
        <p id="punti">0</p>
      </div>
    </div>
      <div class="d-flex align-items-center justify-content-center" style="width:100%;height:100vh;/* text-align: center; */">
        
        <svg preserveAspectRatio="xMinYMin meet"  id="svg" >
          {% for punto in punti %}
            <circle cx="{{punto.x * 100}}%" cy="{{punto.y * 100}}%" x = "{{punto.x * 100}}" y = "{{punto.y * 100}}" r="8" fill="white" data-click ="false"></circle>
          {% endfor %}
        </svg></div>
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="./static/particles.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        particlesJS.load ('particelle', './static/particlesjs-config.json') 
        let seconds = 0;
        let minutes = 0;
        var interval = setInterval(function(){
          seconds += 1;
             if (seconds == 60)
              {
                  seconds = 0;
                  minutes += 1;
              }

            document.getElementById('timer').innerHTML = Math.floor (minutes/10) + minutes%10 + ' : ' + Math.floor (seconds/10) + seconds%10;
             }, 1000);

        var svg_cont = document.getElementById ('svg')

        var x = 0;
        var y = 0;
        var last_click = null;

        var punti = 0;
        var audio = new Audio('./static/audio.wav');

        var order_point_for_animation = Array ()

        const svgns = "http://www.w3.org/2000/svg";

            document.querySelectorAll('circle').forEach (circle => {
                circle.addEventListener ('click', function () {
                  console.log (this.getAttribute('data-click') )
                    if (x == 0 && y == 0)
                    {
                        x = this.getAttribute('x');
                        y = this.getAttribute('y');
                        last_click = this;
                        this.setAttribute('fill', 'green')
                        this.setAttribute ('data-closed', '1')
                        order_point_for_animation.push (this);
                    }
                    else 
                    {
                      if (this.getAttribute('data-click') == 'false' || this.getAttribute('data-closed') == '1' ) 
                      {
                          this.classList.add("on");
                          order_point_for_animation.push (this);
                          punti += Math.sqrt(Math.pow(x - this.getAttribute('x'), 2) + Math.pow(y - this.getAttribute('y'), 2))
                          let line = document.createElementNS(svgns, "line");
                          line.setAttribute ('x1', last_click.getAttribute ('cx'));
                          line.setAttribute ('x2', this.getAttribute('cx'));
                          line.setAttribute ('y1', last_click.getAttribute ('cy'));
                          line.setAttribute ('y2', this.getAttribute('cy'));
                          line.setAttribute ('class', 'line_game');
                          svg_cont.appendChild (line)
                          last_click = this
                          this.setAttribute('data-click', 'true')
                          this.setAttribute('fill', '#ecca53')
                          audio.play();
                          document.getElementById ('punti').innerHTML = parseInt (punti);
                          if ( this.getAttribute('data-closed') == '1')
                          {
                            end_game();
                          }
                      }
                    }
                    
                })
            })

            function end_game () {
              var i = 0;
              let end_game = setInterval(function(){
                    if (i == order_point_for_animation.length)
                      {
                          clearInterval (end_game)
                      }
                      order_point_for_animation[i].classList.add ('end_game_point');
                      i += 1;
                    }, 200);
              
              let y = 0;
              order_line_for_animation = document.getElementsByTagName ('line')
              let end_game_line = setInterval(function(){
                console.log (order_line_for_animation+ ' ' + y)
                  
                    if (y == order_line_for_animation.length)
                      {
                          clearInterval (end_game)
                      }
                      let line = document.createElementNS(svgns, "line");
                      line.setAttribute ('x1', order_line_for_animation[y].getAttribute ('x1'));
                      line.setAttribute ('x2', order_line_for_animation[y].getAttribute('x2'));
                      line.setAttribute ('y1', order_line_for_animation[y].getAttribute ('y1'));
                      line.setAttribute ('y2', order_line_for_animation[y].getAttribute('y2'));
                      line.setAttribute ('class', 'line_game_end');
                      svg_cont.appendChild (line)
                      y += 1;
                    }, 300);
              
                  
            }

            /*var http = new XMLHttpRequest();
            http.open("POST", "/salva_dati")
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                console.log(this.responseText);
              }
            };
            http.send("distanza=5&tempo=6");*/
            
      </script>
    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
  </body>
</html>